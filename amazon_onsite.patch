From 0819326ee693582af46df8e683ac742ad69bb828 Mon Sep 17 00:00:00 2001
From: Mihael Wagner <mihael.wagner@agiledrop.com>
Date: Mon, 14 Dec 2020 11:21:23 +0100
Subject: [PATCH 1/3] Intermittent commit for multiple aop feeds.

---
 src/AopFeedListBuilder.php                    | 29 +++++++
 src/Entity/AopFeed.php                        | 50 ++++++++++++
 src/Entity/AopFeedInterface.php               | 77 +++++++++++++++++++
 src/Form/AopFeedDeleteForm.php                | 33 ++++++++
 .../{SettingsForm.php => AopFeedForm.php}     | 45 ++++-------
 5 files changed, 203 insertions(+), 31 deletions(-)
 create mode 100644 src/AopFeedListBuilder.php
 create mode 100644 src/Entity/AopFeed.php
 create mode 100644 src/Entity/AopFeedInterface.php
 create mode 100644 src/Form/AopFeedDeleteForm.php
 rename src/Form/{SettingsForm.php => AopFeedForm.php} (84%)

diff --git a/src/AopFeedListBuilder.php b/src/AopFeedListBuilder.php
new file mode 100644
index 0000000..15cddbb
--- /dev/null
+++ b/src/AopFeedListBuilder.php
@@ -0,0 +1,29 @@
+<?php
+
+namespace Drupal\amazon_onsite\Controller;
+
+use Drupal\Core\Config\Entity\ConfigEntityListBuilder;
+use Drupal\Core\Entity\EntityInterface;
+
+class AopFeedListBuilder extends ConfigEntityListBuilder {
+
+  /**
+   * {@inheritDoc}
+   */
+  public function buildHeader() {
+    $header['label'] = $this->t('Name');
+    $header['url'] = $this->t('URL');
+    return $header + parent::buildHeader();
+  }
+
+  /**
+   * {@inheritDoc}
+   */
+  public function buildRow(EntityInterface $entity) {
+    /** @var \Drupal\amazon_onsite\Entity\AopFeedInterface $entity */
+    $row['label'] = $entity->label();
+    $row['url'] = $entity->getUrl();
+    return $row + parent::buildRow($entity);
+  }
+
+}
\ No newline at end of file
diff --git a/src/Entity/AopFeed.php b/src/Entity/AopFeed.php
new file mode 100644
index 0000000..785529a
--- /dev/null
+++ b/src/Entity/AopFeed.php
@@ -0,0 +1,50 @@
+<?php
+
+namespace Drupal\amazon_onsite\Entity;
+
+use Drupal\Core\Config\Entity\ConfigEntityBase;
+
+/**
+ * Class AopFeed.
+ *
+ * @package Drupal\amazon_onsite\Entity
+ *
+ * @ConfigEntityType(
+ *   id = "aop_feed",
+ *   label = @Translation("AOP Feed"),
+ *   config_prefix = "aop_feed",
+ *   admin_permission = "",
+ *   entity_keys = {
+ *     "id" = "id",
+ *     "label" = "label",
+ *   },
+ *   handlers = {
+ *     "list_builder" = "Drupal\amazon_onsite\AopFeedListBuilder",
+ *     "form" = {
+ *       "add" = "Drupal\amazon_onsite\Form\AopFeedForm",
+ *       "edit" = "Drupal\amazon_onsite\Form\AopFeedForm",
+ *       "delete" = "Drupal\amazon_onsite\Form\AopFeedDeleteForm",
+ *     },
+ *   },
+ *   links = {
+ *     "canonical" = "/aop/{aop_feed}/rss.xml",
+ *     "edit-form" = "/admin/config/system/aop_feed/{aop_feed}",
+ *     "delete-form" = "/admin/config/system/aop_feed/{aop_feed}/delete",
+ *   },
+ * )
+ */
+class AopFeed extends ConfigEntityBase implements AopFeedInterface {
+
+  /**
+   * {@inheritDoc}
+   */
+  public function getUrl() {
+    try {
+      return $this->toUrl('canonical', ['absolute' => TRUE])->toString();
+    }
+    catch (\Throwable $exception) {
+      return NULL;
+    }
+  }
+
+}
\ No newline at end of file
diff --git a/src/Entity/AopFeedInterface.php b/src/Entity/AopFeedInterface.php
new file mode 100644
index 0000000..4bb26a6
--- /dev/null
+++ b/src/Entity/AopFeedInterface.php
@@ -0,0 +1,77 @@
+<?php
+
+namespace Drupal\amazon_onsite\Entity;
+
+use Drupal\Core\Config\Entity\ConfigEntityInterface;
+
+/**
+ * Interface AopFeedInterface.
+ *
+ * @package Drupal\amazon_onsite\Entity
+ */
+interface AopFeedInterface extends ConfigEntityInterface {
+
+  /**
+   * Returns the URL of the AOP feed.
+   *
+   * @return string
+   *   The URL.
+   */
+  public function getUrl();
+
+  /**
+   * Sets the feed URL.
+   *
+   * @param string $url
+   *   The feed URL.
+   */
+  public function setUrl(string $url);
+
+  /**
+   * Returns the AOP feed description.
+   *
+   * @return string
+   *   The description.
+   */
+  public function getDescription();
+
+  /**
+   * Sets the AOP feed description.
+   *
+   * @param string $description
+   *   The description.
+   */
+  public function setDescription(string $description);
+
+  /**
+   * Returns the path to the AOP feed logo.
+   *
+   * @return string
+   *   The path to the logo.
+   */
+  public function getLogoPath();
+
+  /**
+   * Sets the AOP feed logo path.
+   *
+   * @param string $logoPath
+   *   The logo path.
+   */
+  public function setLogoPath(string $logoPath);
+
+  /**
+   * Returns the ISO639-1 language code of the feed.
+   *
+   * @return string
+   *   ISO639-1 language code.
+   */
+  public function getLanguage();
+
+  /**
+   * Sets the ISO639-1 language of the feed.
+   *
+   * @param string $language
+   *   ISO639-1 language code.
+   */
+  public function setLanguage(string $language);
+}
\ No newline at end of file
diff --git a/src/Form/AopFeedDeleteForm.php b/src/Form/AopFeedDeleteForm.php
new file mode 100644
index 0000000..ec7311a
--- /dev/null
+++ b/src/Form/AopFeedDeleteForm.php
@@ -0,0 +1,33 @@
+<?php
+
+namespace Drupal\amazon_onsite\Form;
+
+use Drupal\Core\Entity\EntityConfirmFormBase;
+use Drupal\Core\Url;
+
+/**
+ * Class AopFeedDeleteForm.
+ *
+ * Builds a form to confirm the deletion of an AOP Feed config entity.
+ *
+ * @package Drupal\amazon_onsite\Form
+ */
+class AopFeedDeleteForm extends EntityConfirmFormBase {
+
+  /**
+   * {@inheritDoc}
+   */
+  public function getQuestion() {
+    return $this->t('Are you sure you want to delete AOP feed @label?', [
+      '@label' => $this->entity->label(),
+    ]);
+  }
+
+  /**
+   * {@inheritDoc}
+   */
+  public function getCancelUrl() {
+    return new Url('entity.aop_feed.collection');
+  }
+
+}
\ No newline at end of file
diff --git a/src/Form/SettingsForm.php b/src/Form/AopFeedForm.php
similarity index 84%
rename from src/Form/SettingsForm.php
rename to src/Form/AopFeedForm.php
index c9502d0..fd2a0ff 100644
--- a/src/Form/SettingsForm.php
+++ b/src/Form/AopFeedForm.php
@@ -3,18 +3,18 @@
 namespace Drupal\amazon_onsite\Form;
 
 use Drupal\Core\Config\ConfigFactoryInterface;
+use Drupal\Core\Entity\EntityForm;
 use Drupal\Core\Extension\ModuleHandlerInterface;
-use Drupal\Core\File\FileSystemInterface;
-use Drupal\Core\Form\ConfigFormBase;
+use Drupal\Core\File\Exception\FileException;
+use Drupal\Core\File\FileSystemInterface;;
 use Drupal\Core\Form\FormStateInterface;
 use Drupal\Core\StreamWrapper\StreamWrapperManager;
-use Drupal\Core\Url;
 use Symfony\Component\DependencyInjection\ContainerInterface;
 
 /**
- * The settings form for amazon onsite module.
+ * The AOP feed form for amazon onsite module.
  */
-class SettingsForm extends ConfigFormBase {
+class AopFeedForm extends EntityForm {
 
   /**
    * Drupal\Core\Extension\ModuleHandlerInterface module handler.
@@ -34,7 +34,6 @@ class SettingsForm extends ConfigFormBase {
    * {@inheritdoc}
    */
   public function __construct(ConfigFactoryInterface $config_factory, ModuleHandlerInterface $module_handler, FileSystemInterface $file_system) {
-    parent::__construct($config_factory);
     $this->moduleHandler = $module_handler;
     $this->fileSystem = $file_system;
   }
@@ -53,43 +52,27 @@ class SettingsForm extends ConfigFormBase {
   /**
    * {@inheritdoc}
    */
-  protected function getEditableConfigNames() {
-    return [
-      'amazon_onsite.settings',
-    ];
-  }
-
-  /**
-   * {@inheritdoc}
-   */
-  public function getFormId() {
-    return 'amazon_onsite_settings_form';
-  }
-
-  /**
-   * {@inheritdoc}
-   */
-  public function buildForm(array $form, FormStateInterface $form_state) {
-    $config = $this->config('amazon_onsite.settings');
+  public function form(array $form, FormStateInterface $form_state) {
+    $feedItem = $this->entity;
 
     $form['channel_title'] = [
       '#type' => 'textfield',
       '#title' => $this->t('Title'),
-      '#default_value' => $config->get('channel_title'),
+      '#default_value' => $feedItem->label(),
       '#required' => TRUE,
     ];
     $form['website_url'] = [
       '#type' => 'url',
       '#title' => $this->t('Website URL'),
       '#description' => $this->t('The website url which is associated with this RSS channel. (HTTPS is required)'),
-      '#default_value' => $config->get('website_url'),
+      '#default_value' => $feedItem->getUrl(),
       '#pattern' => 'https://.*',
       '#required' => TRUE,
     ];
     $form['feed_description'] = [
       '#type' => 'textfield',
       '#title' => $this->t('Feed description'),
-      '#default_value' => $config->get('feed_description'),
+      '#default_value' => $feedItem->getDescription(),
       '#required' => TRUE,
     ];
     $form['logo'] = [
@@ -99,7 +82,7 @@ class SettingsForm extends ConfigFormBase {
     $form['logo']['logo_path'] = [
       '#type' => 'textfield',
       '#title' => $this->t('Path to image'),
-      '#default_value' => $config->get('logo_path'),
+      '#default_value' => $feedItem->getLogoPath(),
     ];
     $form['logo']['logo_upload'] = [
       '#type' => 'file',
@@ -115,13 +98,13 @@ class SettingsForm extends ConfigFormBase {
       '#type' => 'textfield',
       '#title' => $this->t('Language'),
       '#description' => $this->t('ISO639-1 language string'),
-      '#default_value' => $config->get('language'),
+      '#default_value' => $feedItem->getLanguage(),
       '#disabled' => TRUE,
     ];
     $form['channel_url'] = [
       '#type' => 'textfield',
       '#title' => $this->t('Feed URL'),
-      '#default_value' => Url::fromRoute('amazon_onsite.rss', [], ['absolute' => TRUE])->toString(),
+      '#default_value' => $feedItem->toUrl(),
       '#disabled' => TRUE,
     ];
 
@@ -196,7 +179,7 @@ class SettingsForm extends ConfigFormBase {
   /**
    * {@inheritdoc}
    */
-  public function submitForm(array &$form, FormStateInterface $form_state) {
+  public function save(array $form, FormStateInterface $form_state) {
     parent::submitForm($form, $form_state);
 
     try {
-- 
2.24.3 (Apple Git-128)


From 076abc77f6e1776915892dad46628f4150bdc8c6 Mon Sep 17 00:00:00 2001
From: Mihael Wagner <mihael.wagner@agiledrop.com>
Date: Mon, 14 Dec 2020 13:50:40 +0100
Subject: [PATCH 2/3] AopFeed implements interface correctly.

---
 config/schema/amazon_onsite.schema.yml | 23 +++++++
 src/Entity/AopFeed.php                 | 94 ++++++++++++++++++++++++++
 src/Entity/AopFeedInterface.php        |  9 +--
 src/Form/AopFeedForm.php               |  2 +-
 4 files changed, 120 insertions(+), 8 deletions(-)

diff --git a/config/schema/amazon_onsite.schema.yml b/config/schema/amazon_onsite.schema.yml
index 7c4dddd..c239b62 100644
--- a/config/schema/amazon_onsite.schema.yml
+++ b/config/schema/amazon_onsite.schema.yml
@@ -1,3 +1,26 @@
+amazon_onsite.aop_feed.*:
+  type: config_entity
+  label: 'AOP Feed'
+  mapping:
+    id:
+      type: string
+      label: 'ID'
+    channel_title:
+      type: string
+      label: 'Title'
+    website_url:
+      type: string
+      label: 'Website URL'
+    language:
+      type: string
+      label: 'Language'
+    logo_path:
+      type: 'string'
+      label: 'Channel logo'
+    feed_description:
+      type: 'string'
+      label: 'Feed description'
+
 amazon_onsite.settings:
   type: config_object
   label: 'Onsite settings'
diff --git a/src/Entity/AopFeed.php b/src/Entity/AopFeed.php
index 785529a..493601f 100644
--- a/src/Entity/AopFeed.php
+++ b/src/Entity/AopFeed.php
@@ -35,6 +35,55 @@ use Drupal\Core\Config\Entity\ConfigEntityBase;
  */
 class AopFeed extends ConfigEntityBase implements AopFeedInterface {
 
+  /**
+   * The AOP Feed ID.
+   *
+   * @var string
+   */
+  protected $id;
+
+  /**
+   * The AOP Feed title.
+   *
+   * @var string
+   */
+  protected $title;
+
+  /**
+   * The AOP Feed channel title.
+   *
+   * @var string
+   */
+  protected $channel_title;
+
+  /**
+   * The AOP Feed website_url.
+   *
+   * @var string
+   */
+  protected $website_url;
+
+  /**
+   * The AOP Feed language.
+   *
+   * @var string
+   */
+  protected $language;
+
+  /**
+   * The AOP Feed logo path.
+   *
+   * @var string
+   */
+  protected $logo_path;
+
+  /**
+   * The AOP Feed description.
+   *
+   * @var string
+   */
+  protected $feed_description;
+
   /**
    * {@inheritDoc}
    */
@@ -47,4 +96,49 @@ class AopFeed extends ConfigEntityBase implements AopFeedInterface {
     }
   }
 
+  /**
+   * {@inheritDoc}
+   */
+  public function getDescription() {
+    return $this->get('feed_description');
+  }
+
+  /**
+   * {@inheritDoc}
+   */
+  public function setDescription(string $description) {
+    $this->set('feed_description', $description);
+    return $this;
+  }
+
+  /**
+   * {@inheritDoc}
+   */
+  public function getLogoPath() {
+    return $this->get('logo_path');
+  }
+
+  /**
+   * @inheritDoc
+   */
+  public function setLogoPath(string $logoPath) {
+    $this->set('logo_path', $logoPath);
+    return $this;
+  }
+
+  /**
+   * @inheritDoc
+   */
+  public function getLanguage() {
+    return $this->get('language');
+  }
+
+  /**
+   * @inheritDoc
+   */
+  public function setLanguage(string $language) {
+    $this->set('language', $language);
+    return $this;
+  }
+
 }
\ No newline at end of file
diff --git a/src/Entity/AopFeedInterface.php b/src/Entity/AopFeedInterface.php
index 4bb26a6..7729f43 100644
--- a/src/Entity/AopFeedInterface.php
+++ b/src/Entity/AopFeedInterface.php
@@ -19,13 +19,6 @@ interface AopFeedInterface extends ConfigEntityInterface {
    */
   public function getUrl();
 
-  /**
-   * Sets the feed URL.
-   *
-   * @param string $url
-   *   The feed URL.
-   */
-  public function setUrl(string $url);
 
   /**
    * Returns the AOP feed description.
@@ -40,6 +33,8 @@ interface AopFeedInterface extends ConfigEntityInterface {
    *
    * @param string $description
    *   The description.
+   *
+   * @return $this
    */
   public function setDescription(string $description);
 
diff --git a/src/Form/AopFeedForm.php b/src/Form/AopFeedForm.php
index fd2a0ff..72b9136 100644
--- a/src/Form/AopFeedForm.php
+++ b/src/Form/AopFeedForm.php
@@ -192,7 +192,7 @@ class AopFeedForm extends EntityForm {
       // Ignore.
     }
 
-    $this->config('amazon_onsite.settings')
+    $status = $this->entity
       ->set('channel_title', $form_state->getValue('channel_title'))
       ->set('website_url', $form_state->getValue('website_url'))
       ->set('feed_description', $form_state->getValue('feed_description'))
-- 
2.24.3 (Apple Git-128)


From 3ca4da1da5338b8e3d2df5f2ce0daed863ef2190 Mon Sep 17 00:00:00 2001
From: Mihael Wagner <mihael.wagner@agiledrop.com>
Date: Tue, 15 Dec 2020 09:47:56 +0100
Subject: [PATCH 3/3] Working multiple feeds amazon_onsite.

---
 amazon_onsite.install            | 26 +++++++++++
 amazon_onsite.links.action.yml   |  5 ++
 amazon_onsite.links.menu.yml     |  2 +-
 amazon_onsite.routing.yml        | 42 ++++++++++++++++-
 src/AopFeedListBuilder.php       | 11 +++--
 src/Controller/RssController.php | 32 +++++++++----
 src/Entity/AopFeed.php           | 80 +++++++++++++++++++++++---------
 src/Entity/AopFeedInterface.php  | 11 +----
 src/Form/AopFeedDeleteForm.php   | 14 +++++-
 src/Form/AopFeedForm.php         | 57 +++++++++++++++++++++--
 10 files changed, 227 insertions(+), 53 deletions(-)
 create mode 100644 amazon_onsite.install

diff --git a/amazon_onsite.install b/amazon_onsite.install
new file mode 100644
index 0000000..25d7d15
--- /dev/null
+++ b/amazon_onsite.install
@@ -0,0 +1,26 @@
+<?php
+
+/**
+ * @file
+ * Update hooks for amazon_onsite.
+ */
+
+use Drupal\amazon_onsite\Entity\AopFeed;
+
+/**
+ * Migrates AOP feed settings from config settings to config entity.
+ */
+function amazon_onsite_update_8901() {
+  $config = \Drupal::config('amazon_onsite.settings');
+
+  AopFeed::create([
+    'id' => 'default_feed',
+    'channel_title' => $config->get('channel_title'),
+    'website_url' => $config->get('website_url'),
+    'language' => $config->get('language'),
+    'logo_path' => $config->get('logo_path'),
+    'feed_description' => $config->get('feed_description'),
+  ])->save();
+
+  return t('Amazon onsite feed settings have been migrated to config entity.');
+}
diff --git a/amazon_onsite.links.action.yml b/amazon_onsite.links.action.yml
index b6e7f06..c3510a0 100644
--- a/amazon_onsite.links.action.yml
+++ b/amazon_onsite.links.action.yml
@@ -1,3 +1,8 @@
+aop_feed.add_form_link:
+  route_name: entity.aop_feed.add_form
+  title: 'Add AOP feed'
+  appears_on:
+    - 'entity.aop_feed.collection'
 aop_feed_item.add_form:
   route_name: entity.aop_feed_item.add_form
   title: 'Add AOP feed item'
diff --git a/amazon_onsite.links.menu.yml b/amazon_onsite.links.menu.yml
index 977ecd0..b227f73 100644
--- a/amazon_onsite.links.menu.yml
+++ b/amazon_onsite.links.menu.yml
@@ -1,7 +1,7 @@
 amazon_onsite.settings:
   title: Amazon Onsite Publishing configuration
   description: Configure an AOP feed item entity type
-  route_name:  entity.aop_feed_item.settings
+  route_name:  entity.aop_feed.collection
   parent: system.admin_config_services
 entity.aop_feed_item.settings:
   title: Amazon Onsite Publishing feed items
diff --git a/amazon_onsite.routing.yml b/amazon_onsite.routing.yml
index 5e8c512..259dd94 100644
--- a/amazon_onsite.routing.yml
+++ b/amazon_onsite.routing.yml
@@ -8,6 +8,44 @@ amazon_onsite.settings:
   options:
     _admin_route: TRUE
 
+entity.aop_feed.collection:
+  path: '/admin/config/structure/aop-feeds'
+  defaults:
+    _entity_list: 'aop_feed'
+    _title: 'AOP Feeds'
+  requirements:
+    _permission: 'administer aop feeds'
+
+entity.aop_feed.add_form:
+  path: '/admin/config/structure/aop-feeds/add'
+  defaults:
+    _entity_form: aop_feed.add
+    _title: 'Add AOP Feed'
+  requirements:
+    _permission: 'add aop feed'
+  options:
+    _admin_route: TRUE
+
+entity.aop_feed.edit_form:
+  path: '/admin/config/structure/aop-feeds/{aop_feed}/edit'
+  defaults:
+    _entity_form: aop_feed.edit
+    _title: 'Edit AOP Feed'
+  requirements:
+    _permission: 'edit aop feed'
+  options:
+    _admin_route: TRUE
+
+entity.aop_feed.delete_form:
+  path: '/admin/config/structure/aop-feeds/{aop_feed}/delete'
+  defaults:
+    _entity_form: aop_feed.delete
+    _title: 'Delete AOP Feed'
+  requirements:
+    _permission: 'delete aop feed'
+  options:
+    _admin_route: TRUE
+
 entity.aop_feed_item.settings:
   path: 'admin/structure/aop-feed-item'
   defaults:
@@ -16,8 +54,8 @@ entity.aop_feed_item.settings:
   requirements:
     _permission: 'administer aop feed item'
 
-amazon_onsite.rss:
-  path: '/aop/rss'
+entity.aop_feed.canonical:
+  path: '/aop/{aop_feed}/rss.xml'
   defaults:
     _controller: '\Drupal\amazon_onsite\Controller\RssController::buildResponse'
   requirements:
diff --git a/src/AopFeedListBuilder.php b/src/AopFeedListBuilder.php
index 15cddbb..fbc07da 100644
--- a/src/AopFeedListBuilder.php
+++ b/src/AopFeedListBuilder.php
@@ -1,10 +1,15 @@
 <?php
 
-namespace Drupal\amazon_onsite\Controller;
+namespace Drupal\amazon_onsite;
 
 use Drupal\Core\Config\Entity\ConfigEntityListBuilder;
 use Drupal\Core\Entity\EntityInterface;
 
+/**
+ * Class AopFeedListBuilder.
+ *
+ * @package Drupal\amazon_onsite
+ */
 class AopFeedListBuilder extends ConfigEntityListBuilder {
 
   /**
@@ -22,8 +27,8 @@ class AopFeedListBuilder extends ConfigEntityListBuilder {
   public function buildRow(EntityInterface $entity) {
     /** @var \Drupal\amazon_onsite\Entity\AopFeedInterface $entity */
     $row['label'] = $entity->label();
-    $row['url'] = $entity->getUrl();
+    $row['url'] = $entity->toUrl('canonical', ['absolute' => TRUE]);
     return $row + parent::buildRow($entity);
   }
 
-}
\ No newline at end of file
+}
diff --git a/src/Controller/RssController.php b/src/Controller/RssController.php
index bc78071..cfc64ea 100644
--- a/src/Controller/RssController.php
+++ b/src/Controller/RssController.php
@@ -31,6 +31,13 @@ class RssController extends ControllerBase {
    */
   protected $renderer;
 
+  /**
+   * Entity type manager.
+   *
+   * @var \Drupal\Core\Entity\EntityTypeManagerInterface
+   */
+  protected $entityTypeManager;
+
   /**
    * {@inheritdoc}
    */
@@ -38,6 +45,7 @@ class RssController extends ControllerBase {
     $instance = parent::create($container);
     $instance->dateFormatter = $container->get('date.formatter');
     $instance->renderer = $container->get('renderer');
+    $instance->entityTypeManager = $container->get('entity_type.manager');
     return $instance;
   }
 
@@ -50,8 +58,8 @@ class RssController extends ControllerBase {
    * @throws \Drupal\Component\Plugin\Exception\InvalidPluginDefinitionException
    * @throws \Drupal\Component\Plugin\Exception\PluginNotFoundException
    */
-  public function buildResponse() {
-    $build = $this->build();
+  public function buildResponse(string $aop_feed) {
+    $build = $this->build($aop_feed);
     // Set up an empty response, so for example RSS can set the proper
     // Content-Type header.
     $response = new CacheableResponse('', 200);
@@ -78,14 +86,18 @@ class RssController extends ControllerBase {
   /**
    * Build a render array for the RSS feed.
    *
+   * @param string $id
+   *   The id of the aop_feed.
+   *
    * @return array
    *   An array as expected by drupal_render().
    *
    * @throws \Drupal\Component\Plugin\Exception\InvalidPluginDefinitionException
    * @throws \Drupal\Component\Plugin\Exception\PluginNotFoundException
    */
-  public function build() {
-    $config = $this->config('amazon_onsite.settings');
+  public function build($id) {
+    $feedStorage = $this->entityTypeManager->getStorage('aop_feed');
+    $entity = $feedStorage->load($id);
 
     $required_configs = [
       'channel_title',
@@ -95,19 +107,19 @@ class RssController extends ControllerBase {
     ];
 
     foreach ($required_configs as $required_config) {
-      if (empty($config->get($required_config))) {
+      if (empty($entity->get($required_config))) {
         throw new \Exception("$required_config needs to be set.");
       }
     }
 
     return [
       '#theme' => 'rss_feed',
-      '#title' => $config->get('channel_title'),
-      '#link' => $config->get('website_url'),
-      '#description' => $config->get('feed_description'),
-      '#langcode' => $config->get('language'),
+      '#title' => $entity->get('channel_title'),
+      '#link' => $entity->get('website_url'),
+      '#description' => $entity->get('feed_description'),
+      '#langcode' => $entity->get('language'),
       '#last_build_date' => $this->getLastBuildDate(),
-      '#logo_path' => $config->get('logo_path') ? file_create_url($config->get('logo_path')) : '',
+      '#logo_path' => $entity->get('logo_path') ? file_create_url($entity->get('logo_path')) : '',
       '#items' => $this->buildItems(),
     ];
   }
diff --git a/src/Entity/AopFeed.php b/src/Entity/AopFeed.php
index 493601f..e9edeb6 100644
--- a/src/Entity/AopFeed.php
+++ b/src/Entity/AopFeed.php
@@ -13,7 +13,7 @@ use Drupal\Core\Config\Entity\ConfigEntityBase;
  *   id = "aop_feed",
  *   label = @Translation("AOP Feed"),
  *   config_prefix = "aop_feed",
- *   admin_permission = "",
+ *   admin_permission = "administer aop feeds",
  *   entity_keys = {
  *     "id" = "id",
  *     "label" = "label",
@@ -28,8 +28,9 @@ use Drupal\Core\Config\Entity\ConfigEntityBase;
  *   },
  *   links = {
  *     "canonical" = "/aop/{aop_feed}/rss.xml",
- *     "edit-form" = "/admin/config/system/aop_feed/{aop_feed}",
- *     "delete-form" = "/admin/config/system/aop_feed/{aop_feed}/delete",
+ *     "add-form" = "/admin/config/structure/aop_feed/add",
+ *     "edit-form" = "/admin/config/structure/aop_feed/{aop_feed}/edit",
+ *     "delete-form" = "/admin/config/structure/aop_feed/{aop_feed}/delete",
  *   },
  * )
  */
@@ -40,60 +41,78 @@ class AopFeed extends ConfigEntityBase implements AopFeedInterface {
    *
    * @var string
    */
-  protected $id;
+  public $id;
 
   /**
    * The AOP Feed title.
    *
    * @var string
    */
-  protected $title;
+  public $title;
 
   /**
    * The AOP Feed channel title.
    *
    * @var string
    */
-  protected $channel_title;
+  public $channel_title;
 
   /**
    * The AOP Feed website_url.
    *
    * @var string
    */
-  protected $website_url;
+  public $website_url;
 
   /**
    * The AOP Feed language.
    *
    * @var string
    */
-  protected $language;
+  public $language;
 
   /**
    * The AOP Feed logo path.
    *
    * @var string
    */
-  protected $logo_path;
+  public $logo_path;
 
   /**
    * The AOP Feed description.
    *
    * @var string
    */
-  protected $feed_description;
+  public $feed_description;
+
+  /**
+   * Returns the feed title.
+   *
+   * @return string
+   */
+  public function label() {
+    return $this->getTitle();
+  }
+
+  public function setTitle(string $title) {
+    $this->set('channel_title', $title);
+    return $this;
+  }
+
+  public function getTitle() {
+    return $this->get('channel_title');
+  }
 
   /**
    * {@inheritDoc}
    */
-  public function getUrl() {
-    try {
-      return $this->toUrl('canonical', ['absolute' => TRUE])->toString();
-    }
-    catch (\Throwable $exception) {
-      return NULL;
-    }
+  public function getWebsiteUrl() {
+    return $this->get('website_url');
+  }
+
+  public function setWebsiteUrl(string $url) {
+    $this->set('website_url', $url);
+    return $this;
   }
 
   /**
@@ -119,7 +138,7 @@ class AopFeed extends ConfigEntityBase implements AopFeedInterface {
   }
 
   /**
-   * @inheritDoc
+   * {@inheritDoc}
    */
   public function setLogoPath(string $logoPath) {
     $this->set('logo_path', $logoPath);
@@ -127,18 +146,37 @@ class AopFeed extends ConfigEntityBase implements AopFeedInterface {
   }
 
   /**
-   * @inheritDoc
+   * {@inheritDoc}
    */
   public function getLanguage() {
     return $this->get('language');
   }
 
   /**
-   * @inheritDoc
+   * {@inheritDoc}
    */
   public function setLanguage(string $language) {
     $this->set('language', $language);
     return $this;
   }
 
-}
\ No newline at end of file
+  /**
+   * {@inheritDoc}
+   */
+  public function getUrl() {
+    return $this->toUrl('canonical', ['absolute' => TRUE])->toString();
+  }
+
+  /**
+   * Allowed languages codes for AOP Feed.
+   *
+   * @return array
+   *   The language codes.
+   */
+  public static function supportedLanguages() {
+    return [
+      'de-DE' => 'de-DE',
+    ];
+  }
+
+}
diff --git a/src/Entity/AopFeedInterface.php b/src/Entity/AopFeedInterface.php
index 7729f43..b8546f0 100644
--- a/src/Entity/AopFeedInterface.php
+++ b/src/Entity/AopFeedInterface.php
@@ -11,15 +11,6 @@ use Drupal\Core\Config\Entity\ConfigEntityInterface;
  */
 interface AopFeedInterface extends ConfigEntityInterface {
 
-  /**
-   * Returns the URL of the AOP feed.
-   *
-   * @return string
-   *   The URL.
-   */
-  public function getUrl();
-
-
   /**
    * Returns the AOP feed description.
    *
@@ -69,4 +60,4 @@ interface AopFeedInterface extends ConfigEntityInterface {
    *   ISO639-1 language code.
    */
   public function setLanguage(string $language);
-}
\ No newline at end of file
+}
diff --git a/src/Form/AopFeedDeleteForm.php b/src/Form/AopFeedDeleteForm.php
index ec7311a..9d88d88 100644
--- a/src/Form/AopFeedDeleteForm.php
+++ b/src/Form/AopFeedDeleteForm.php
@@ -3,6 +3,7 @@
 namespace Drupal\amazon_onsite\Form;
 
 use Drupal\Core\Entity\EntityConfirmFormBase;
+use Drupal\Core\Form\FormStateInterface;
 use Drupal\Core\Url;
 
 /**
@@ -30,4 +31,15 @@ class AopFeedDeleteForm extends EntityConfirmFormBase {
     return new Url('entity.aop_feed.collection');
   }
 
-}
\ No newline at end of file
+  /**
+   * {@inheritDoc}
+   */
+  public function submitForm(array &$form, FormStateInterface $form_state) {
+    $this->entity->delete();
+    $this->messenger()->addMessage($this->t('The entity "@label" has been deleted.', [
+      '@label' => $this->entity->label(),
+    ]));
+    $form_state->setRedirectUrl($this->getCancelUrl());
+  }
+
+}
diff --git a/src/Form/AopFeedForm.php b/src/Form/AopFeedForm.php
index 72b9136..bb8295b 100644
--- a/src/Form/AopFeedForm.php
+++ b/src/Form/AopFeedForm.php
@@ -2,6 +2,7 @@
 
 namespace Drupal\amazon_onsite\Form;
 
+use Drupal\amazon_onsite\Entity\AopFeed;
 use Drupal\Core\Config\ConfigFactoryInterface;
 use Drupal\Core\Entity\EntityForm;
 use Drupal\Core\Extension\ModuleHandlerInterface;
@@ -55,6 +56,15 @@ class AopFeedForm extends EntityForm {
   public function form(array $form, FormStateInterface $form_state) {
     $feedItem = $this->entity;
 
+    $form['id'] = [
+      '#type' => 'machine_name',
+      '#default_value' => $feedItem->id(),
+      '#machine_name' => [
+        'exists' => [$this, 'exist'],
+      ],
+      '#disabled' => !$feedItem->isNew(),
+    ];
+
     $form['channel_title'] = [
       '#type' => 'textfield',
       '#title' => $this->t('Title'),
@@ -65,7 +75,7 @@ class AopFeedForm extends EntityForm {
       '#type' => 'url',
       '#title' => $this->t('Website URL'),
       '#description' => $this->t('The website url which is associated with this RSS channel. (HTTPS is required)'),
-      '#default_value' => $feedItem->getUrl(),
+      '#default_value' => $feedItem->getWebsiteUrl(),
       '#pattern' => 'https://.*',
       '#required' => TRUE,
     ];
@@ -95,20 +105,20 @@ class AopFeedForm extends EntityForm {
     ];
 
     $form['language'] = [
-      '#type' => 'textfield',
+      '#type' => 'select',
+      '#options' => AopFeed::supportedLanguages(),
       '#title' => $this->t('Language'),
       '#description' => $this->t('ISO639-1 language string'),
       '#default_value' => $feedItem->getLanguage(),
-      '#disabled' => TRUE,
     ];
     $form['channel_url'] = [
       '#type' => 'textfield',
       '#title' => $this->t('Feed URL'),
-      '#default_value' => $feedItem->toUrl(),
+      '#default_value' => $feedItem->getUrl(),
       '#disabled' => TRUE,
     ];
 
-    return parent::buildForm($form, $form_state);
+    return parent::form($form, $form_state);
   }
 
   /**
@@ -140,6 +150,12 @@ class AopFeedForm extends EntityForm {
         }
       }
     }
+
+    if ($form_state->getValue('language')) {
+      if (!in_array($form_state->getValue('language'), AopFeed::supportedLanguages())) {
+        $form_state->setErrorByName('language', $this->t('Language is invalid.'));
+      }
+    }
   }
 
   /**
@@ -199,6 +215,37 @@ class AopFeedForm extends EntityForm {
       ->set('language', $form_state->getValue('language'))
       ->set('logo_path', !empty($logo_path) ? $logo_path : $form_state->getValue('logo_path'))
       ->save();
+
+    if ($status === SAVED_NEW) {
+      $this->messenger()->addMessage($this->t('Aop feed "@name" successfully added.', [
+        '@name' => $this->entity->label(),
+      ]));
+    }
+    else {
+      $this->messenger()->addMessage($this->t('Aop feed "@name" was changed..', [
+        '@name' => $this->entity->label(),
+      ]));
+    }
+    $form_state->setRedirect('entity.aop_feed.collection');
+  }
+
+  /**
+   * Checks if the entity exists.
+   *
+   * @param string $id
+   *   The entity machine name.
+   *
+   * @return bool
+   *   TRUE if entity exists, FALSE otherwise.
+   *
+   * @throws \Drupal\Component\Plugin\Exception\InvalidPluginDefinitionException
+   * @throws \Drupal\Component\Plugin\Exception\PluginNotFoundException
+   */
+  public function exist($id) {
+    $entity = $this->entityTypeManager->getStorage('aop_feed')->getQuery()
+      ->condition('id', $id)
+      ->execute();
+    return (bool) $entity;
   }
 
 }
-- 
2.24.3 (Apple Git-128)

